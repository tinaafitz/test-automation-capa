# ======================================================
# Configure CAPI/CAPA Environment - Main Task
# ======================================================
# This role configures the CAPI/CAPA environment with the following sequential steps:
# 1. Enable CAPI/CAPA (which automatically disables Hypershift if needed)
# 2. Wait for CAPI/CAPA controllers to be ready
# 3. Create necessary configuration objects
# ======================================================

- name: Set automation path
  set_fact:
    automation_path: "{{ AUTOMATION_PATH | default(playbook_dir) }}"

# ======================================================
# STEP 1: Enable CAPI/CAPA (Disables Hypershift First)
# ======================================================
- name: Enable CAPI/CAPA components
  debug:
    msg: |

      ‚è≥ STEP 1: Enabling CAPI/CAPA Components

      This will:
      - Disable Hypershift and hypershift-local-hosting (if enabled)
      - Enable cluster-api component
      - Enable cluster-api-provider-aws component

- name: Execute CAPI/CAPA enablement
  include_tasks: "{{ automation_path }}/tasks/enable_capi_capa.yml"

- name: CAPI/CAPA enablement complete
  debug:
    msg: "‚úÖ STEP 1 COMPLETE: CAPI/CAPA components enabled"

# ======================================================
# STEP 2: Wait for CAPI/CAPA Controllers to be Ready
# ======================================================
- name: Wait for controllers to be ready
  debug:
    msg: |

      ‚è≥ STEP 2: Waiting for CAPI/CAPA Controllers to be Ready

      This will wait for:
      - capi-controller-manager deployment to be available
      - capa-controller-manager deployment to be available

      This may take several minutes...

- name: Execute controller readiness wait
  include_tasks: "{{ automation_path }}/tasks/wait-for-capi-capa-ready.yml"

- name: Controllers ready
  debug:
    msg: "‚úÖ STEP 2 COMPLETE: CAPI/CAPA controllers are ready"

# ======================================================
# STEP 3: Create Configuration Objects
# ======================================================
- name: Create configuration objects
  debug:
    msg: |

      ‚è≥ STEP 3: Creating Configuration Objects

      This will create:
      - {{ capi_namespace }} namespace
      - ClusterManager registration configuration
      - ClusterRoleBinding for registration-capi
      - AWS credentials secret (capa-manager-bootstrap-credentials)
      - ROSA credentials secret (rosa-creds-secret)
      - AWSClusterControllerIdentity

- name: Create output folder
  include_tasks: "{{ automation_path }}/tasks/create_output_folder.yml"

- name: Create {{ capi_namespace }} namespace
  shell: |
    oc create namespace {{ capi_namespace }} --dry-run=client -o yaml | oc apply -f -

- name: Set ClusterManager registration_configuration
  include_tasks: "{{ automation_path }}/tasks/set_registration_configuration.yml"

- name: Set ClusterRoleBinding registration-capi
  include_tasks: "{{ automation_path }}/tasks/set_cluster_role_binding.yml"

- name: Create capa-manager-bootstrap-credentials with AWS Credentials
  include_tasks: "{{ automation_path }}/tasks/create_capa_manager_bootstrap_credentials.yml"

- name: Create rosa-creds-secret in multicluster-engine ns.
  include_tasks: "{{ automation_path }}/tasks/create_rosa_creds_secret.yml"

- name: Restart capa-controller-manager deployment.
  include_tasks: "{{ automation_path }}/tasks/restart_capa_controller_manager.yml"

- name: Set the AWSClusterControllerIdentity
  include_tasks: "{{ automation_path }}/tasks/set_aws_identity.yml"

- name: Configuration objects created
  debug:
    msg: "‚úÖ STEP 3 COMPLETE: All configuration objects created"

# ======================================================
# FINAL: Configuration Complete
# ======================================================
- name: Configuration complete summary
  debug:
    msg: |

      ‚úÖ ‚úÖ ‚úÖ CAPI/CAPA CONFIGURATION COMPLETE! ‚úÖ ‚úÖ ‚úÖ

      All steps completed successfully:

      ‚úì STEP 1: CAPI/CAPA components enabled (Hypershift disabled)
      ‚úì STEP 2: Controllers are ready and available
      ‚úì STEP 3: Configuration objects created

      Your environment is now ready to provision ROSA HCP clusters!

      Next steps:
      - Create ROSA HCP clusters using the UI
      - Upload YAML templates to provision clusters
      - Monitor cluster status and resources

      Happy cluster provisioning! üöÄ
