---
# Task 09: Create EC2NodeClass
# Creates EC2NodeClass for Karpenter node provisioning

- name: Display EC2NodeClass creation start
  debug:
    msg: |
      ========================================
      Creating EC2NodeClass
      ========================================
      Name: {{ nodeclass_name }}
      Cluster ID: {{ cluster_id }}

- name: Wait for Karpenter CRDs to be available
  shell: |
    kubectl --kubeconfig={{ autonode_kubeconfig_path }} get crd ec2nodeclasses.karpenter.k8s.aws
  register: crd_check
  until: crd_check.rc == 0
  retries: 30
  delay: 10
  changed_when: false
  failed_when: false

- name: Verify Karpenter CRDs are installed
  assert:
    that:
      - crd_check.rc == 0
    fail_msg: |
      Karpenter CRDs are not installed on the cluster.

      AutoNode configuration was applied to RosaControlPlane, but Karpenter has not been deployed yet.
      This can take 5-10 minutes after enabling AutoNode.

      Please wait a few minutes and check:
      1. RosaControlPlane status: kubectl get rosacontrolplane {{ cluster_name }} -n {{ cluster_namespace }}
      2. Karpenter pods: kubectl get pods -n kube-system | grep karpenter

      Once Karpenter is running, you can manually create EC2NodeClass and NodePool resources.
    success_msg: " Karpenter CRDs are available"

- name: Set EC2NodeClass manifest path
  set_fact:
    ec2nodeclass_manifest: "/tmp/{{ nodeclass_name }}-ec2nodeclass.yaml"

- name: Generate OpenshiftEC2NodeClass manifest from template
  template:
    src: ec2nodeclass.yaml.j2
    dest: "{{ ec2nodeclass_manifest }}"
    mode: '0644'

- name: Check if EC2NodeClass already exists
  shell: |
    kubectl --kubeconfig={{ autonode_kubeconfig_path }} get ec2nodeclass {{ nodeclass_name }}
  register: ec2nodeclass_check
  failed_when: false
  changed_when: false

- name: Apply OpenshiftEC2NodeClass manifest
  shell: |
    kubectl --kubeconfig={{ autonode_kubeconfig_path }} apply -f {{ ec2nodeclass_manifest }}
  register: ec2nodeclass_apply
  changed_when: "'created' in ec2nodeclass_apply.stdout or 'configured' in ec2nodeclass_apply.stdout"

- name: Wait for EC2NodeClass to be ready
  shell: |
    kubectl --kubeconfig={{ autonode_kubeconfig_path }} get ec2nodeclass {{ nodeclass_name }} -o json
  register: ec2nodeclass_status
  until: (ec2nodeclass_status.stdout | from_json).status.ready == true
  retries: 20
  delay: 5
  changed_when: false
  failed_when: false

- name: Get EC2NodeClass details
  shell: |
    kubectl --kubeconfig={{ autonode_kubeconfig_path }} get ec2nodeclass {{ nodeclass_name }} -o yaml
  register: ec2nodeclass_details
  changed_when: false

- name: Display EC2NodeClass information
  debug:
    msg: |
      ========================================
      OpenshiftEC2NodeClass Created
      ========================================
      Name: {{ nodeclass_name }}
      Status: {{ 'Ready' if ec2nodeclass_status.rc == 0 else 'Pending' }}
      Security Groups: Tagged with karpenter.sh/discovery={{ cluster_id }}
      Subnets: Tagged with karpenter.sh/discovery={{ cluster_id }}

- name: Verify EC2NodeClass configuration
  shell: |
    kubectl --kubeconfig={{ autonode_kubeconfig_path }} describe ec2nodeclass {{ nodeclass_name }}
  register: ec2nodeclass_describe
  changed_when: false

- name: Save EC2NodeClass manifest
  copy:
    src: "{{ ec2nodeclass_manifest }}"
    dest: "{{ autonode_results_dir }}/{{ nodeclass_name }}-ec2nodeclass-{{ ansible_date_time.epoch }}.yaml"
    mode: '0644'
  when: autonode_results_dir is defined
