---
# Task 04: Create Trust Policy
# Generates IAM trust policy for the AutoNode role with OIDC federation

- name: Display trust policy creation start
  debug:
    msg: |
      ========================================
      Creating Trust Policy
      ========================================
      OIDC Provider: {{ oidc_provider_url }}
      AWS Account: {{ aws_account_id }}

- name: Set trust policy file path
  set_fact:
    trust_policy_file: "/tmp/{{ autonode_role_name }}-trust-policy.json"

- name: Generate trust policy from template
  template:
    src: trust-policy.json.j2
    dest: "{{ trust_policy_file }}"
    mode: '0644'

- name: Display trust policy
  debug:
    msg: |
      Trust Policy File: {{ trust_policy_file }}
      OIDC Provider: {{ oidc_provider_url }}

- name: Validate trust policy JSON format
  shell: |
    cat {{ trust_policy_file }} | jq empty
  register: trust_policy_validation
  failed_when: trust_policy_validation.rc != 0
  changed_when: false

- name: Display trust policy validation result
  debug:
    msg: " Trust policy JSON is valid"
