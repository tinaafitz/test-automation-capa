---
# Task 02: Create AutoNode IAM Policy
# Creates the IAM policy with required Karpenter permissions

- name: Display IAM policy creation start
  debug:
    msg: |
      ========================================
      Creating AutoNode IAM Policy
      ========================================
      Policy Name: {{ autonode_policy_name }}
      AWS Account: {{ aws_account_id }}

- name: Set policy file path
  set_fact:
    autonode_policy_file: "/tmp/{{ autonode_policy_name }}.json"

- name: Generate AutoNode IAM policy from template
  template:
    src: autonode-policy.json.j2
    dest: "{{ autonode_policy_file }}"
    mode: '0644'

- name: Check if AutoNode IAM policy already exists
  shell: |
    aws iam list-policies --query 'Policies[?PolicyName==`{{ autonode_policy_name }}`].Arn' --output text
  environment:
    AWS_DEFAULT_REGION: "{{ aws_region }}"
  register: existing_policy_check
  changed_when: false
  failed_when: false

- name: Create AutoNode IAM policy in AWS
  shell: |
    aws iam create-policy \
      --policy-name {{ autonode_policy_name }} \
      --policy-document file://{{ autonode_policy_file }} \
      --description "AutoNode (Karpenter) policy for ROSA HCP cluster {{ cluster_name }}" \
      --query 'Policy.Arn' \
      --output text
  environment:
    AWS_DEFAULT_REGION: "{{ aws_region }}"
  register: policy_creation_result
  when: existing_policy_check.stdout == ""
  changed_when: policy_creation_result.rc == 0

- name: Set policy ARN fact (newly created)
  set_fact:
    autonode_policy_arn: "{{ policy_creation_result.stdout }}"
  when: existing_policy_check.stdout == ""

- name: Set policy ARN fact (existing)
  set_fact:
    autonode_policy_arn: "{{ existing_policy_check.stdout }}"
  when: existing_policy_check.stdout != ""

- name: Display policy information
  debug:
    msg: |
      AutoNode IAM Policy:
      {{ ' Created' if existing_policy_check.stdout == '' else ' Already exists' }}
      Policy Name: {{ autonode_policy_name }}
      Policy ARN: {{ autonode_policy_arn }}

- name: Validate policy was created successfully
  shell: |
    aws iam get-policy --policy-arn {{ autonode_policy_arn }}
  environment:
    AWS_DEFAULT_REGION: "{{ aws_region }}"
  register: policy_validation
  failed_when: policy_validation.rc != 0
  changed_when: false

- name: Clean up temporary policy file
  file:
    path: "{{ autonode_policy_file }}"
    state: absent
