---
# Main task file for test-autonode-feature role
# This orchestrates the complete AutoNode testing workflow

- name: Display AutoNode test start message
  debug:
    msg: |
      ========================================
      AutoNode Feature Testing
      ========================================
      Cluster: {{ cluster_name }}
      Mode: {{ autonode_mode }}
      AWS Region: {{ aws_region }}
      Namespace: {{ cluster_namespace }}
      ========================================

- name: Set test start time
  set_fact:
    autonode_test_start_time: "{{ ansible_date_time.iso8601 }}"

- name: Create results directory
  file:
    path: "{{ autonode_results_dir }}"
    state: directory
    mode: '0755'
  when: autonode_results_dir is defined

# Step 1: Validate Prerequisites
- name: Step 1 - Validate Prerequisites
  include_tasks: 01-validate-prerequisites.yml
  when: autonode_validate_prerequisites | default(true)
  tags:
    - validate
    - prerequisites
    - step1

# Step 2: Create IAM Policy
- name: Step 2 - Create IAM Policy
  include_tasks: 02-create-iam-policy.yml
  when: not autonode_skip_iam_creation | default(false)
  tags:
    - iam
    - policy
    - step2

# Step 3: Get Cluster Information
- name: Step 3 - Get Cluster Information
  include_tasks: 03-get-cluster-info.yml
  tags:
    - cluster
    - info
    - step3

# Step 4: Create Trust Policy
- name: Step 4 - Create Trust Policy
  include_tasks: 04-create-trust-policy.yml
  when: not autonode_skip_iam_creation | default(false)
  tags:
    - trust
    - policy
    - step4

# Step 5: Create IAM Role
- name: Step 5 - Create IAM Role
  include_tasks: 05-create-iam-role.yml
  when: not autonode_skip_iam_creation | default(false)
  tags:
    - iam
    - role
    - step5

# Step 6: Update RosaControlPlane
- name: Step 6 - Update RosaControlPlane
  include_tasks: 06-update-rosacontrolplane.yml
  tags:
    - rosacontrolplane
    - update
    - step6

# Step 7: Tag AWS Resources
- name: Step 7 - Tag AWS Resources
  include_tasks: 07-tag-aws-resources.yml
  when: not autonode_skip_resource_tagging | default(false)
  tags:
    - aws
    - tags
    - step7

# Step 8: Create Kubeconfig
- name: Step 8 - Create Kubeconfig
  include_tasks: 08-create-kubeconfig.yml
  when: not autonode_skip_kubeconfig_creation | default(false)
  tags:
    - kubeconfig
    - credentials
    - step8

# Step 9: Create EC2NodeClass
- name: Step 9 - Create EC2NodeClass
  include_tasks: 09-create-ec2nodeclass.yml
  tags:
    - ec2nodeclass
    - karpenter
    - step9

# Step 10: Create NodePool
- name: Step 10 - Create NodePool
  include_tasks: 10-create-nodepool.yml
  tags:
    - nodepool
    - karpenter
    - step10

# Step 11: Verify AutoNode
- name: Step 11 - Verify AutoNode Installation
  include_tasks: 11-verify-autonode.yml
  tags:
    - verify
    - validation
    - step11

# Step 12: Test Scaling (optional)
- name: Step 12 - Test AutoNode Scaling
  include_tasks: 12-test-scaling.yml
  when: AUTONODE_TESTING.scaling_test_enabled | default(true)
  tags:
    - test
    - scaling
    - step12

- name: Set test completion time
  set_fact:
    autonode_test_end_time: "{{ ansible_date_time.iso8601 }}"

- name: Display AutoNode test completion message
  debug:
    msg: |
      ========================================
      AutoNode Test Completed Successfully
      ========================================
      Cluster: {{ cluster_name }}
      Started: {{ autonode_test_start_time }}
      Completed: {{ autonode_test_end_time }}
      Results: {{ autonode_results_dir | default('N/A') }}
      ========================================
