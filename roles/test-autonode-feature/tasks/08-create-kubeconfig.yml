---
# Task 08: Create Kubeconfig for Cluster Access
# Creates cluster admin credentials and generates kubeconfig file

- name: Display kubeconfig creation start
  debug:
    msg: |
      ========================================
      Creating Kubeconfig
      ========================================
      Cluster: {{ cluster_name }}
      Kubeconfig Path: {{ autonode_kubeconfig_path }}

- name: Check if admin user already exists
  shell: |
    rosa list users --cluster {{ cluster_name }} | grep -E '^cluster-admin\s'
  register: admin_user_check
  failed_when: false
  changed_when: false

- name: Delete existing admin user to create fresh credentials
  shell: |
    rosa delete admin --cluster {{ cluster_name }} --yes
  register: admin_deletion
  when: admin_user_check.rc == 0
  changed_when: admin_deletion.rc == 0
  failed_when: false

- name: Create cluster admin user
  shell: |
    rosa create admin --cluster {{ cluster_name }}
  register: admin_creation
  changed_when: admin_creation.rc == 0

- name: Parse admin password from creation output
  set_fact:
    admin_password: "{{ (admin_creation.stdout_lines | select('search', '--password') | first).split('--password')[1].strip() }}"
  when: admin_creation is defined and admin_creation is not skipped and admin_creation.rc == 0

- name: Wait for admin user to become active
  pause:
    seconds: 30
    prompt: "Waiting for admin user to become active on the cluster..."
  when: admin_creation is defined and admin_creation is not skipped and admin_creation.rc == 0

- name: Get API URL from cluster details
  set_fact:
    api_url: "{{ cluster_details.api.url }}"

- name: Check if admin password was extracted
  assert:
    that:
      - admin_password is defined
      - admin_password != ""
    fail_msg: |
      Failed to extract cluster admin password.

      {% if admin_user_check.rc == 0 %}
      The admin user already exists, and ROSA doesn't allow retrieving existing passwords.

      Option 1 - Delete and recreate admin (recommended for automation):
        rosa delete admin --cluster {{ cluster_name }}
        Then re-run this AutoNode configuration

      Option 2 - Use existing credentials manually:
        If you have the existing admin password, you can create the kubeconfig manually:
        1. Run: oc login {{ cluster_details.api.url }} -u cluster-admin -p <your-password>
        2. Run: oc config view --minify --flatten > {{ autonode_kubeconfig_path }}
        3. Re-run with: autonode_skip_kubeconfig_creation=true

      Option 3 - Skip kubeconfig step (won't complete EC2NodeClass/NodePool creation):
        Add extra_vars: autonode_skip_kubeconfig_creation=true
      {% else %}
      The 'rosa create admin' command may have changed format.

      Manual steps:
      1. Run: rosa create admin --cluster {{ cluster_name }}
      2. Copy the password from the output
      3. Run: oc login {{ cluster_details.api.url }} -u cluster-admin -p <password>
      4. Run: oc config view --minify --flatten > {{ autonode_kubeconfig_path }}
      {% endif %}
    success_msg: " Admin password extracted successfully"

- name: Display admin credentials
  debug:
    msg: |
      Admin Username: cluster-admin
      API URL: {{ api_url }}

- name: Login to cluster using admin credentials
  shell: |
    oc login {{ api_url }} \
      --username cluster-admin \
      --password {{ admin_password }} \
      --insecure-skip-tls-verify=true
  register: oc_login_result
  until: oc_login_result.rc == 0
  retries: 5
  delay: 10
  changed_when: false
  no_log: true

- name: Get current context name
  shell: |
    oc config current-context
  register: current_context
  changed_when: false

- name: Export kubeconfig to file
  shell: |
    oc config view --minify --flatten --context={{ current_context.stdout }} > {{ autonode_kubeconfig_path }}
  register: kubeconfig_export
  changed_when: kubeconfig_export.rc == 0

- name: Set kubeconfig file permissions
  file:
    path: "{{ autonode_kubeconfig_path }}"
    mode: '0600'

- name: Verify kubeconfig works
  shell: |
    kubectl --kubeconfig={{ autonode_kubeconfig_path }} cluster-info
  register: kubeconfig_verification
  failed_when: kubeconfig_verification.rc != 0
  changed_when: false

- name: Display kubeconfig information
  debug:
    msg: |
      ========================================
      Kubeconfig Created
      ========================================
       Admin user: cluster-admin
       API URL: {{ api_url }}
       Kubeconfig file: {{ autonode_kubeconfig_path }}

      You can use this kubeconfig with:
      kubectl --kubeconfig={{ autonode_kubeconfig_path }} <command>
