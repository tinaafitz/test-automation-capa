---
apiVersion: karpenter.sh/v1beta1
kind: NodePool
metadata:
  name: {{ nodepool_name }}
spec:
  # Template for nodes launched by Karpenter
  template:
    metadata:
      labels:
        karpenter.sh/nodepool: {{ nodepool_name }}
        node-role.kubernetes.io/worker: ""
        {% if autonode_node_labels is defined %}
        {% for key, value in autonode_node_labels.items() %}
        {{ key }}: {{ value }}
        {% endfor %}
        {% endif %}
    spec:
      # Reference to EC2NodeClass
      nodeClassRef:
        name: {{ nodeclass_name }}

      # Requirements for node provisioning
      requirements:
        - key: kubernetes.io/arch
          operator: In
          values:
            - amd64
        - key: kubernetes.io/os
          operator: In
          values:
            - linux
        - key: karpenter.sh/capacity-type
          operator: In
          values:
            {% for capacity_type in autonode_capacity_types %}
            - {{ capacity_type }}
            {% endfor %}
        - key: node.kubernetes.io/instance-type
          operator: In
          values:
            {% for instance_type in autonode_instance_types %}
            - {{ instance_type }}
            {% endfor %}
        {% if autonode_availability_zones is defined %}
        - key: topology.kubernetes.io/zone
          operator: In
          values:
            {% for az in autonode_availability_zones %}
            - {{ az }}
            {% endfor %}
        {% endif %}

      # Taints for workload isolation (optional)
      {% if autonode_node_taints is defined %}
      taints:
        {% for taint in autonode_node_taints %}
        - key: {{ taint.key }}
          value: {{ taint.value | default('') }}
          effect: {{ taint.effect }}
        {% endfor %}
      {% endif %}

  # Limits for node provisioning
  limits:
    cpu: {{ autonode_max_cpu | default('1000') }}
    memory: {{ autonode_max_memory | default('1000Gi') }}

  # Disruption budget - controls when nodes can be removed
  disruption:
    consolidationPolicy: {{ autonode_consolidation_policy | default('WhenUnderutilized') }}
    consolidateAfter: {{ autonode_consolidate_after | default('30s') }}
    expireAfter: {{ autonode_expire_after | default('720h') }}

  # Weight for multi-pool scheduling
  weight: {{ autonode_nodepool_weight | default(10) }}
