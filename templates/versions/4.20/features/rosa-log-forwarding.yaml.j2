apiVersion: cluster.open-cluster-management.io/v1
kind: ManagedCluster
metadata:
  name: {{ cluster_name }}
  namespace: {{ capi_namespace }}
  labels:
    automation.acm.redhat.com/test-case: "ROSA-LogForwarding"
    automation.acm.redhat.com/pr-5786: "true"
spec:
  hubAcceptsClient: true
---
apiVersion: cluster.x-k8s.io/v1beta1
kind: Cluster
metadata:
  name: {{ cluster_name }}
  namespace: {{ capi_namespace }}
  labels:
    automation.acm.redhat.com/test-case: "ROSA-LogForwarding"
    automation.acm.redhat.com/pr-5786: "true"
spec:
  clusterNetwork:
    pods:
      cidrBlocks: ["{{ cluster_network.pod_cidr | default('192.168.0.0/16') }}"]
  infrastructureRef:
    apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
    kind: ROSACluster
    name: {{ cluster_name }}
    namespace: {{ capi_namespace }}
  controlPlaneRef:
    apiVersion: controlplane.cluster.x-k8s.io/v1beta2
    kind: ROSAControlPlane
    name: {{ cluster_name }}
    namespace: {{ capi_namespace }}
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
kind: ROSACluster
metadata:
  name: {{ cluster_name }}
  namespace: {{ capi_namespace }}
  labels:
    automation.acm.redhat.com/test-case: "ROSA-LogForwarding"
    automation.acm.redhat.com/pr-5786: "true"
spec: {}
---
# ROSANetwork for automated VPC and subnet creation
apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
kind: ROSANetwork
metadata:
  name: {{ cluster_name }}-network
  namespace: {{ capi_namespace }}
  labels:
    cluster.x-k8s.io/cluster-name: {{ cluster_name }}
    automation.acm.redhat.com/test-case: "ROSA-LogForwarding"
    automation.acm.redhat.com/created-by: "ansible-automation"
spec:
  identityRef:
    kind: AWSClusterControllerIdentity
    name: {{ rosa_network_config.identity_name | default('default') }}
  credentialsSecretRef:
    name: {{ rosa_creds_secret }}
  availabilityZones:
    {% for az in rosa_network_config.availability_zones %}
    - {{ az }}
    {% endfor %}
  cidrBlock: {{ rosa_network_config.cidr_block | default('10.0.0.0/16') }}
  tags:
    Environment: {{ environment_tag | default('test') }}
    TestCase: "ROSA-LogForwarding"
    CreatedBy: "ansible-automation"
    Purpose: "pr-5786-testing"
---
# ROSARoleConfig for automated AWS IAM role creation
{% if rosa_role_config is defined and rosa_role_config.enabled | default(false) %}
apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
kind: ROSARoleConfig
metadata:
  name: {{ cluster_name }}-roles
  namespace: {{ capi_namespace }}
  labels:
    cluster.x-k8s.io/cluster-name: {{ cluster_name }}
    automation.acm.redhat.com/test-case: "ROSA-LogForwarding"
    automation.acm.redhat.com/created-by: "ansible-automation"
spec:
  identityRef:
    kind: AWSClusterControllerIdentity
    name: {{ rosa_role_config.identity_name | default('default') }}
  credentialsSecretRef:
    name: {{ rosa_creds_secret }}
  accountRoleConfig:
    prefix: "{{ rosa_role_config.prefix | default(cluster_name_prefix) }}"
    version: {{ rosa_role_config.version | default(openshift_version) }}
  operatorRoleConfig:
    prefix: "{{ rosa_role_config.prefix | default(cluster_name_prefix) }}"
{% endif %}
---
apiVersion: controlplane.cluster.x-k8s.io/v1beta2
kind: ROSAControlPlane
metadata:
  name: {{ cluster_name }}
  namespace: {{ capi_namespace }}
  labels:
    automation.acm.redhat.com/test-case: "ROSA-LogForwarding"
    automation.acm.redhat.com/pr-5786: "true"
  annotations:
    cluster.x-k8s.io/description: |
      ROSA HCP cluster with log forwarding enabled
      Testing PR: https://github.com/kubernetes-sigs/cluster-api-provider-aws/pull/5786
spec:
  # Network automation reference
  rosaNetworkRef:
    name: {{ cluster_name }}-network
    namespace: {{ capi_namespace }}

  # Role automation reference (if enabled)
  {% if rosa_role_config is defined and rosa_role_config.enabled | default(false) %}
  rosaRoleConfigRef:
    name: {{ cluster_name }}-roles
    namespace: {{ capi_namespace }}
  {% endif %}

  rosaClusterName: {{ cluster_name }}
  domainPrefix: {{ domain_prefix | default('rosa-' + cluster_name_prefix) }}
  version: {{ openshift_version }}
  region: {{ aws_region }}
  channelGroup: {{ channel_group | default('stable') }}

  defaultMachinePoolSpec:
    instanceType: {{ machine_pool.instance_type | default('m5.xlarge') }}
    autoscaling:
      maxReplicas: {{ machine_pool.max_replicas | default(3) }}
      minReplicas: {{ machine_pool.min_replicas | default(2) }}

  additionalTags:
    env: {{ environment_tag | default('test') }}
    purpose: {{ purpose_tag | default('log-forwarding-test') }}
    automated: "true"
    pr-test: "5786"
    feature: "log-forwarding"

  network:
    machineCIDR: {{ cluster_network.machine_cidr | default('10.0.0.0/16') }}
    podCIDR: {{ cluster_network.pod_cidr | default('10.128.0.0/14') }}
    serviceCIDR: {{ cluster_network.service_cidr | default('172.30.0.0/16') }}

  # ======================================
  # LOG FORWARDING CONFIGURATION
  # PR: https://github.com/kubernetes-sigs/cluster-api-provider-aws/pull/5786
  # ======================================
  {% if log_forward_enabled | default(false) %}
  cloudWatchlogForwarder:
    # CloudWatch configuration
    {% if log_forward_cloudwatch_role_arn is defined and log_forward_cloudwatch_role_arn %}
    cloudWatchLogRoleArn: {{ log_forward_cloudwatch_role_arn | trim }}
    {% endif %}
    {% if log_forward_cloudwatch_log_group is defined and log_forward_cloudwatch_log_group %}
    cloudWatchLogGroupName: {{ log_forward_cloudwatch_log_group | trim }}
    {% endif %}

    # S3 configuration (optional)
    {% if log_forward_s3_bucket is defined and log_forward_s3_bucket %}
    s3ConfigBucketName: {{ log_forward_s3_bucket | trim }}
    {% endif %}
    {% if log_forward_s3_prefix is defined and log_forward_s3_prefix %}
    s3ConfigBucketPrefix: {{ log_forward_s3_prefix | trim }}
    {% endif %}

    # Applications to forward logs for
    {% if log_forward_applications is defined and log_forward_applications | length > 0 %}
    applications:
      {% for app in log_forward_applications %}
      - {{ app | trim }}
      {% endfor %}
    {% endif %}

    # Log version groups (optional)
    {% if log_forward_groups_log_version is defined and log_forward_groups_log_version | length > 0 %}
    groupLogVersions:
      {% for version in log_forward_groups_log_version %}
      - {{ version | trim }}
      {% endfor %}
    {% endif %}
  {% endif %}
---
apiVersion: cluster.x-k8s.io/v1beta1
kind: MachinePool
metadata:
  name: {{ cluster_name }}
  namespace: {{ capi_namespace }}
  labels:
    automation.acm.redhat.com/test-case: "ROSA-LogForwarding"
    automation.acm.redhat.com/pr-5786: "true"
spec:
  clusterName: {{ cluster_name }}
  replicas: {{ machine_pool.replicas | default(2) }}
  template:
    spec:
      clusterName: {{ cluster_name }}
      bootstrap:
        dataSecretName: ""
      infrastructureRef:
        name: {{ cluster_name }}
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
        kind: ROSAMachinePool
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
kind: ROSAMachinePool
metadata:
  name: {{ cluster_name }}
  namespace: {{ capi_namespace }}
  labels:
    automation.acm.redhat.com/test-case: "ROSA-LogForwarding"
    automation.acm.redhat.com/pr-5786: "true"
spec:
  nodePoolName: {{ machine_pool.node_pool_name | default(cluster_name + '-nodepool') }}
  instanceType: {{ machine_pool.instance_type | default('m5.xlarge') }}
  version: {{ openshift_version }}
  # Note: subnet assignment will be automatic via ROSANetwork
