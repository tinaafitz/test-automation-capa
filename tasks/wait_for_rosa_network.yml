---
# Wait for ROSANetwork to complete VPC and subnet creation
- name: "Wait for ROSANetwork to be ready for cluster {{ cluster_name }}"
  block:
    - name: Display wait configuration
      debug:
        msg:
          - "Waiting for ROSANetwork: {{ rosa_network_config_name | default(cluster_name + '-network') }}"
          - "Namespace: {{ capi_namespace }}"
          - "Timeout: {{ rosa_network_creation_timeout | default(900) }} seconds"

    - name: Wait for ROSANetwork to complete network creation
      shell: |
        set -e
        NETWORK_NAME="{{ rosa_network_config_name | default(cluster_name + '-network') }}"
        NAMESPACE="{{ capi_namespace }}"
        TIMEOUT="{{ rosa_network_creation_timeout | default(900) }}"
        START_TIME=$(date +%s)

        echo "Waiting for ROSANetwork ${NETWORK_NAME} in namespace ${NAMESPACE} to be Ready..."

        while true; do
          CURRENT_TIME=$(date +%s)
          ELAPSED=$((CURRENT_TIME - START_TIME))

          if [ $ELAPSED -gt $TIMEOUT ]; then
            echo "ERROR: Timeout after ${TIMEOUT} seconds waiting for ROSANetwork to be Ready"
            exit 1
          fi

          # Check if ROSANetwork exists
          if ! oc get rosanetwork "${NETWORK_NAME}" -n "${NAMESPACE}" &>/dev/null; then
            echo "Waiting for ROSANetwork to be created... (${ELAPSED}s elapsed)"
            sleep 5
            continue
          fi

          # Check Ready condition
          READY_STATUS=$(oc get rosanetwork "${NETWORK_NAME}" -n "${NAMESPACE}" \
            -o jsonpath='{.status.conditions[?(@.type=="ROSANetworkReady")].status}' 2>/dev/null || echo "")

          if [ "$READY_STATUS" = "True" ]; then
            echo "✓ ROSANetwork is Ready after ${ELAPSED} seconds"

            # Get full status for output
            oc get rosanetwork "${NETWORK_NAME}" -n "${NAMESPACE}" -o json > /tmp/rosanetwork_status.json
            exit 0
          else
            READY_REASON=$(oc get rosanetwork "${NETWORK_NAME}" -n "${NAMESPACE}" \
              -o jsonpath='{.status.conditions[?(@.type=="ROSANetworkReady")].reason}' 2>/dev/null || echo "Unknown")
            echo "Waiting for Ready condition... Status: ${READY_STATUS:-Pending} Reason: ${READY_REASON} (${ELAPSED}s elapsed)"
            sleep 10
          fi
        done
      args:
        executable: /bin/bash
      register: network_wait_result

    - name: Load ROSANetwork status from file
      shell: cat /tmp/rosanetwork_status.json
      register: network_status_json
      changed_when: false

    - name: Parse network status
      set_fact:
        network_ready_parsed: "{{ network_status_json.stdout | from_json }}"

    - name: Extract network status information
      set_fact:
        network_status: "{{ network_ready_parsed.status }}"

    - name: Display network creation progress
      debug:
        msg:
          - "ROSANetwork Condition Ready: {{ 'Yes' if (network_status.conditions | selectattr('type', 'equalto', 'ROSANetworkReady') | selectattr('status', 'equalto', 'True') | list | length > 0) else 'No' }}"
          - "Conditions: {{ network_status.conditions | default([]) | length }}"
          - "CloudFormation Resources: {{ network_status.resources | default([]) | length }}"
          - "Subnets Configured: {{ network_status.subnets | default([]) | length }} AZs"

    - name: Verify all network components are ready
      assert:
        that:
          - network_status.conditions | selectattr('type', 'equalto', 'ROSANetworkReady') | selectattr('status', 'equalto', 'True') | list | length > 0
          - network_status.subnets is defined
          - network_status.subnets | length > 0
          - network_status.resources is defined
          - network_status.resources | length > 0
        fail_msg: "Not all network components are ready"
        success_msg: "All network components are ready"

    - name: Extract VPC ID from resources
      set_fact:
        vpc_resource: "{{ network_status.resources | selectattr('logicalId', 'equalto', 'VPC') | first }}"

    - name: Display detailed network resource information
      debug:
        msg: |
          ✓ ROSANetwork Ready Status:
          VPC ID: {{ vpc_resource.physicalId }}
          Subnets by Availability Zone:
          {% for subnet in network_status.subnets %}
            - {{ subnet.availabilityZone }}: Public={{ subnet.publicSubnet }}, Private={{ subnet.privateSubnet }}
          {% endfor %}
          Total CloudFormation Resources: {{ network_status.resources | length }}

    - name: Wait additional time for AWS resource propagation
      pause:
        seconds: "{{ aws_network_propagation_delay | default(30) }}"
      when: network_status.conditions | selectattr('type', 'equalto', 'ROSANetworkReady') | selectattr('status', 'equalto', 'True') | list | length > 0

    - name: Final validation - check all required resources are available
      assert:
        that:
          - vpc_resource.physicalId is defined
          - network_status.subnets | length >= 1
          - network_status.conditions | selectattr('type', 'equalto', 'ROSANetworkReady') | selectattr('status', 'equalto', 'True') | list | length > 0
        fail_msg: "Network resources are not properly configured"
        success_msg: "All network resources are available for cluster creation"

    - name: Set network facts for cluster creation
      set_fact:
        rosa_network_vpc_id: "{{ vpc_resource.physicalId }}"
        rosa_network_subnets: "{{ network_status.subnets }}"
        rosa_network_ready: true

    - name: Display network readiness confirmation
      debug:
        msg:
          - "✓ ROSANetwork is ready for cluster creation"
          - "✓ VPC: {{ rosa_network_vpc_id }}"
          - "✓ Availability Zones: {{ rosa_network_subnets | length }}"
          - "✓ Network automation completed successfully"

    - name: Cleanup temporary file
      file:
        path: /tmp/rosanetwork_status.json
        state: absent
      changed_when: false

  rescue:
    - name: Handle network readiness timeout
      debug:
        msg: "ROSANetwork readiness check timed out or failed"

    - name: Get current ROSANetwork status for debugging
      shell: |
        oc get rosanetwork "{{ rosa_network_config_name | default(cluster_name + '-network') }}" \
          -n "{{ capi_namespace }}" -o json 2>/dev/null || echo '{"error": "Resource not found"}'
      register: debug_network_status_raw
      changed_when: false
      ignore_errors: true

    - name: Parse debug network status
      set_fact:
        debug_network_status: "{{ debug_network_status_raw.stdout | from_json }}"
      when: debug_network_status_raw.stdout is defined

    - name: Display current status for debugging
      debug:
        var: debug_network_status.status
      when:
        - debug_network_status is defined
        - debug_network_status.status is defined

    - name: Get ROSANetwork events for troubleshooting
      shell: |
        oc get events -n "{{ capi_namespace }}" --field-selector \
          involvedObject.name="{{ rosa_network_config_name | default(cluster_name + '-network') }}" \
          -o json 2>/dev/null || echo '{"items": []}'
      register: network_events_raw
      changed_when: false
      ignore_errors: true

    - name: Parse network events
      set_fact:
        network_events: "{{ network_events_raw.stdout | from_json }}"
      when: network_events_raw.stdout is defined

    - name: Display events for troubleshooting
      debug:
        var: network_events.items
      when:
        - network_events is defined
        - network_events.items is defined
        - network_events.items | length > 0

    - name: Provide troubleshooting guidance
      debug:
        msg:
          - "ROSANetwork Troubleshooting Steps:"
          - "1. Check CAPA controller logs:"
          - "   oc logs -n multicluster-engine deployment/capa-controller-manager"
          - "2. Verify AWS credentials and permissions"
          - "3. Check CloudFormation stack status in AWS console"
          - "4. Verify network CRDs are properly installed"
          - "5. Check for AWS service limits or region issues"

    - name: Cleanup temporary file on error
      file:
        path: /tmp/rosanetwork_status.json
        state: absent
      changed_when: false
      ignore_errors: true

    - name: Fail the task
      fail:
        msg: "ROSANetwork failed to become ready within timeout period"
