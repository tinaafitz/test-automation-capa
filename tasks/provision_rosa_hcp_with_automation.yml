---
# ================================================================
# Provision ROSA HCP Cluster with Conditional Automation
# ================================================================
# This task orchestrates ROSA HCP cluster provisioning with optional
# automated creation of RosaRoleConfig and ROSANetwork resources.
#
# Variables:
#   - cluster_name: Name of the cluster to create (required)
#   - create_rosa_roles: Boolean to create RosaRoleConfig (default: false)
#   - create_rosa_network: Boolean to create ROSANetwork (default: false)
#   - rosa_role_prefix: Prefix for AWS role names (default: cluster_name)
#   - network_cidr: CIDR block for VPC (default: 10.0.0.0/16)
#   - availability_zones: List of AZs (default: auto-detected from region)
# ================================================================

- name: Set default value for cluster_name
  set_fact:
    cluster_name: "test-cluster"
  when: cluster_name is not defined

- name: Set default value for rosa_role_prefix
  set_fact:
    rosa_role_prefix: "{{ cluster_name }}"
  when: rosa_role_prefix is not defined

- name: Set default value for rosa_role_config_name
  set_fact:
    rosa_role_config_name: "{{ cluster_name }}-roles"
  when: rosa_role_config_name is not defined

- name: Set default value for rosa_network_name
  set_fact:
    rosa_network_name: "{{ cluster_name }}-network"
  when: rosa_network_name is not defined

- name: Set default value for network_cidr
  set_fact:
    network_cidr: "10.0.0.0/16"
  when: network_cidr is not defined

- name: Set default value for availability_zone_count
  set_fact:
    availability_zone_count: 1
  when: availability_zone_count is not defined

- name: Set default value for create_rosa_roles
  set_fact:
    create_rosa_roles: false
  when: create_rosa_roles is not defined

- name: Set default value for create_rosa_network
  set_fact:
    create_rosa_network: false
  when: create_rosa_network is not defined

- name: Ensure boolean types for flags
  set_fact:
    create_rosa_roles: "{{ create_rosa_roles | bool }}"
    create_rosa_network: "{{ create_rosa_network | bool }}"

- name: Set default value for aws_region
  set_fact:
    aws_region: "us-west-2"
  when: aws_region is not defined

- name: Set default value for openshift_version
  set_fact:
    openshift_version: "4.20.10"
  when: openshift_version is not defined

- name: Set default value for capi_namespace
  set_fact:
    capi_namespace: "ns-rosa-hcp"
  when: capi_namespace is not defined

- name: Display provisioning plan
  debug:
    msg: |
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ğŸš€ ROSA HCP Cluster Provisioning Plan
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      Cluster Name: {{ cluster_name }}
      Namespace: {{ capi_namespace }}
      AWS Region: {{ aws_region }}
      OpenShift Version: {{ openshift_version }}

      Automation Options:
      â”œâ”€ Create RosaRoleConfig: {{ 'âœ“ Enabled' if (create_rosa_roles | bool) else 'âœ— Disabled' }}
      {% if create_rosa_roles | bool %}
      â”‚  â”œâ”€ Role Config Name: {{ rosa_role_config_name }}
      â”‚  â””â”€ Role Prefix: {{ rosa_role_prefix }}
      {% endif %}
      â”‚
      â””â”€ Create ROSANetwork: {{ 'âœ“ Enabled' if (create_rosa_network | bool) else 'âœ— Disabled' }}
      {% if create_rosa_network | bool %}
         â”œâ”€ Network Name: {{ rosa_network_name }}
         â”œâ”€ CIDR Block: {{ network_cidr }}
         â””â”€ Availability Zones: {{ availability_zone_count }}
      {% endif %}

      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# ================================================================
# PRE-STEP: Verify AWS Credentials are Present (if automation enabled)
# ================================================================
- name: Verify AWS credentials are configured
  when: create_rosa_roles | bool or create_rosa_network | bool
  block:
    - name: Check if AWS credentials are provided
      debug:
        msg: |
          ğŸ” Checking AWS credentials...
          AWS_ACCESS_KEY_ID: {{ 'Set âœ“' if AWS_ACCESS_KEY_ID is defined and AWS_ACCESS_KEY_ID != '' else 'Missing âœ—' }}
          AWS_SECRET_ACCESS_KEY: {{ 'Set âœ“' if AWS_SECRET_ACCESS_KEY is defined and AWS_SECRET_ACCESS_KEY != '' else 'Missing âœ—' }}

    - name: Fail if AWS credentials are missing
      fail:
        msg: |
          âŒ AWS Automation Failed: Missing AWS credentials

          RosaRoleConfig and ROSANetwork require valid AWS credentials.

          To use automation features, ensure AWS credentials are configured:
          1. Set environment variables or Ansible extra vars:
             - AWS_ACCESS_KEY_ID
             - AWS_SECRET_ACCESS_KEY
             - AWS_REGION (optional, defaults to us-west-2)

          2. In Jenkins, these should be passed via the Jenkinsfile:
             -e AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}"
             -e AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}"

          Note: Credentials will be validated when AWS resources are created.
          If credentials are invalid, you'll see specific AWS API errors.

          Alternatively, disable automation and provide existing infrastructure:
          - Uncheck "Create RosaRoleConfig"
          - Uncheck "Create ROSANetwork"
          - Manually provide AWS IAM roles, OIDC, and VPC/subnets
      when:
        - (AWS_ACCESS_KEY_ID is not defined or AWS_ACCESS_KEY_ID == '') or
          (AWS_SECRET_ACCESS_KEY is not defined or AWS_SECRET_ACCESS_KEY == '')

    - name: Credentials check passed
      debug:
        msg: "âœ… AWS credentials are present and will be validated during resource creation"

# ================================================================
# STEP 1: Create RosaRoleConfig (if requested)
# ================================================================
- name: Create RosaRoleConfig for automated AWS role creation
  when: create_rosa_roles | bool
  block:
    - name: Display RosaRoleConfig creation message
      debug:
        msg: |

          â³ STEP 1/3: Creating RosaRoleConfig
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          This will automatically create AWS IAM roles:
          â€¢ Installer Role
          â€¢ Support Role
          â€¢ Worker Role
          â€¢ OIDC Provider

    - name: Create RosaRoleConfig resource
      include_tasks: create_rosa_role_config.yml

    - name: Wait for RosaRoleConfig to be ready
      include_tasks: wait_for_rosa_roles.yml
      vars:
        wait_timeout: 600

    - name: RosaRoleConfig creation complete
      debug:
        msg: |
          âœ… STEP 1 COMPLETE: RosaRoleConfig created successfully

          AWS Resources Created:
          â€¢ Installer Role ARN: {{ installer_role_arn | default('N/A') }}
          â€¢ Support Role ARN: {{ support_role_arn | default('N/A') }}
          â€¢ Worker Role ARN: {{ worker_role_arn | default('N/A') }}
          â€¢ OIDC Provider ARN: {{ oidc_provider_arn | default('N/A') }}

- name: Skip RosaRoleConfig creation
  when: not (create_rosa_roles | bool)
  debug:
    msg: |

      â© STEP 1/3: Skipping RosaRoleConfig creation
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      Using existing AWS roles or manual role configuration.

# ================================================================
# STEP 2: Create ROSANetwork (if requested)
# ================================================================
- name: Create ROSANetwork for automated VPC/subnet creation
  when: create_rosa_network | bool
  block:
    - name: Display ROSANetwork creation message
      debug:
        msg: |

          â³ STEP 2/3: Creating ROSANetwork
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          This will automatically create AWS network resources:
          â€¢ VPC ({{ network_cidr }})
          â€¢ Public Subnets ({{ availability_zone_count }} AZ{{ 's' if availability_zone_count | int > 1 else '' }})
          â€¢ Private Subnets ({{ availability_zone_count }} AZ{{ 's' if availability_zone_count | int > 1 else '' }})
          â€¢ Internet Gateway
          â€¢ NAT Gateway{{ 's' if availability_zone_count | int > 1 else '' }}
          â€¢ Route Tables

    - name: Create ROSANetwork resource
      include_tasks: create_rosa_network.yml
      vars:
        rosa_network_config_name: "{{ rosa_network_name }}"
        vpc_cidr_block: "{{ network_cidr }}"

    - name: Wait for ROSANetwork to be ready
      include_tasks: wait_for_rosa_network.yml
      vars:
        wait_timeout: 900

    - name: ROSANetwork creation complete
      debug:
        msg: |
          âœ… STEP 2 COMPLETE: ROSANetwork created successfully

          AWS Network Resources Created:
          â€¢ VPC ID: {{ vpc_id | default('N/A') }}
          â€¢ Public Subnets: {{ public_subnets | length if public_subnets is defined else 0 }}
          â€¢ Private Subnets: {{ private_subnets | length if private_subnets is defined else 0 }}
          â€¢ CloudFormation Stack: {{ cloudformation_stack | default('N/A') }}

- name: Skip ROSANetwork creation
  when: not (create_rosa_network | bool)
  debug:
    msg: |

      â© STEP 2/3: Skipping ROSANetwork creation
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      Using existing VPC/subnets or manual network configuration.

# ================================================================
# STEP 3: Create RosaControlPlane
# ================================================================
- name: Create RosaControlPlane with references to automated resources
  block:
    - name: Display RosaControlPlane creation message
      debug:
        msg: |

          â³ STEP 3/3: Creating RosaControlPlane
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Creating ROSA HCP cluster with:
          {% if create_rosa_roles | bool %}
          â€¢ RosaRoleConfig reference: {{ rosa_role_config_name }}
          {% endif %}
          {% if create_rosa_network | bool %}
          â€¢ ROSANetwork reference: {{ rosa_network_name }}
          {% endif %}

    - name: Determine which template to use
      set_fact:
        cluster_template_name: >-
          {%- if (create_rosa_roles | bool) or (create_rosa_network | bool) -%}
          rosa-controlplane-only
          {%- else -%}
          rosa-control-plane
          {%- endif -%}
        selected_template_category: >-
          {%- if (create_rosa_roles | bool) or (create_rosa_network | bool) -%}
          features
          {%- else -%}
          cluster-configs
          {%- endif -%}

    - name: Display selected template
      debug:
        msg: |
          Selected template: {{ cluster_template_name }}
          Template category: {{ selected_template_category }}
          Template path: templates/versions/{{ openshift_version }}/{{ selected_template_category }}/{{ cluster_template_name }}.yaml.j2

    - name: Build availability zones list from count
      set_fact:
        availability_zones_list: "{{ (availability_zones_list_string | from_yaml) }}"
      vars:
        availability_zones_list_string: >-
          {%- if availability_zone_count | int == 1 -%}
          ['{{ aws_region }}a']
          {%- elif availability_zone_count | int == 2 -%}
          ['{{ aws_region }}a', '{{ aws_region }}b']
          {%- elif availability_zone_count | int == 3 -%}
          ['{{ aws_region }}a', '{{ aws_region }}b', '{{ aws_region }}c']
          {%- else -%}
          ['{{ aws_region }}a']
          {%- endif -%}
      when: create_rosa_network | bool

    - name: Set rosa_network_config for template
      set_fact:
        rosa_network_config:
          identity_name: "default"
          cidr_block: "{{ network_cidr }}"
          availability_zones: "{{ availability_zones_list }}"
      when: create_rosa_network | bool

    - name: Set rosa_role_config for template
      set_fact:
        rosa_role_config:
          identity_name: "default"
          prefix: "{{ rosa_role_prefix }}"
          version: "{{ openshift_version }}"
          enabled: true
      when: create_rosa_roles | bool

    - name: Set cluster network configuration
      set_fact:
        cluster_network:
          machine_cidr: "10.0.0.0/16"
          pod_cidr: "10.128.0.0/14"
          service_cidr: "172.30.0.0/16"

    - name: Set template variables for cluster creation
      set_fact:
        template_vars:
          cluster_name: "{{ cluster_name }}"
          rcp_version: "{{ openshift_version }}"
          rosa_role_config_ref: "{{ rosa_role_config_name if (create_rosa_roles | bool) else omit }}"
          rosa_network_ref: "{{ rosa_network_name if (create_rosa_network | bool) else omit }}"
          create_rosa_roles: "{{ create_rosa_roles | bool }}"
          create_rosa_network: "{{ create_rosa_network | bool }}"

    - name: Create RosaControlPlane from template
      include_tasks: create_rosa_control_plane_versioned.yml
      vars:
        template_name: "{{ cluster_template_name }}"
        template_category: "{{ selected_template_category }}"
        rcp_version: "{{ openshift_version }}"
        apply_immediately: true

    - name: RosaControlPlane creation complete
      debug:
        msg: |
          âœ… STEP 3 COMPLETE: RosaControlPlane created successfully

          Cluster: {{ cluster_name }}
          Namespace: {{ capi_namespace }}
          {% if create_rosa_roles | bool %}
          RosaRoleConfig: {{ rosa_role_config_name }} âœ“
          {% endif %}
          {% if create_rosa_network | bool %}
          ROSANetwork: {{ rosa_network_name }} âœ“
          {% endif %}

# ================================================================
# STEP 4: Wait for ROSA HCP Cluster to be Ready
# ================================================================
- name: Wait for ROSA HCP cluster provisioning to complete
  block:
    - name: Display cluster readiness wait message
      debug:
        msg: |

          â³ STEP 4/4: Waiting for ROSA HCP Cluster to be Ready
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          This will wait for the ROSA HCP cluster to fully provision in AWS.

          Cluster: {{ cluster_name }}
          Expected time: 10-20 minutes
          Maximum wait: 37.5 minutes

          Monitoring: oc get rosacontrolplane {{ cluster_name }} -n {{ capi_namespace }} -w

    - name: Wait for ROSAControlPlane to be ready
      include_tasks: wait_for_rosa_control_plane_ready.yml

    - name: Cluster ready confirmation
      debug:
        msg: |
          âœ… STEP 4 COMPLETE: ROSA HCP cluster is READY!

          Cluster: {{ cluster_name }}
          Status: Fully provisioned and running

# ================================================================
# FINAL: Provisioning Complete
# ================================================================
- name: Display final provisioning summary
  debug:
    msg: |

      âœ… âœ… âœ… ROSA HCP CLUSTER PROVISIONING COMPLETE! âœ… âœ… âœ…

      Cluster Name: {{ cluster_name }}
      Namespace: {{ capi_namespace }}

      Resources Created:
      {% if create_rosa_roles | bool %}
      âœ“ RosaRoleConfig: {{ rosa_role_config_name }}
        â”œâ”€ Installer Role
        â”œâ”€ Support Role
        â”œâ”€ Worker Role
        â””â”€ OIDC Provider
      {% endif %}
      {% if create_rosa_network | bool %}
      âœ“ ROSANetwork: {{ rosa_network_name }}
        â”œâ”€ VPC: {{ vpc_id | default('N/A') }}
        â”œâ”€ Public Subnets: {{ public_subnets | length if public_subnets is defined else 0 }}
        â””â”€ Private Subnets: {{ private_subnets | length if private_subnets is defined else 0 }}
      {% endif %}
      âœ“ RosaControlPlane: {{ cluster_name }} (READY âœ“)

      Cluster Status: FULLY PROVISIONED AND RUNNING

      Next Steps:
      1. Get cluster console URL: oc get rosacontrolplane {{ cluster_name }} -n {{ capi_namespace }} -o jsonpath='{.status.consoleURL}'
      2. Get kubeconfig: oc get secret {{ cluster_name }}-kubeconfig -n {{ capi_namespace }}
      3. View cluster in ROSA console
      4. Begin testing CAPI workflows

      ğŸš€ Your ROSA HCP cluster is ready to use!
