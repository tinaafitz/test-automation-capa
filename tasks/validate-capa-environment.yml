# ======================================================
# CAPI/CAPA Environment Validation Task
# ======================================================
# This task validates the MCE environment in sequential steps:
# 1. Check OCP login succeeded
# 2. Check CAPI/CAPA controllers are deployed
# 3. Check for cluster resources (only if above pass)
# ======================================================

# ======================================================
# STEP 1: Verify OCP Login
# ======================================================
- name: Verify OCP context is set (from login)
  fail:
    msg: "â„¹ï¸  Not connected to OpenShift cluster yet - Click the 'Credentials' button to connect to your hub cluster"
  when: ocp_context is not defined or ocp_context == ''

- name: OCP Login Check
  debug:
    msg: "âœ… Step 1/3: OCP login successful - Context: {{ ocp_context }}"

# ======================================================
# STEP 2: Verify CAPI/CAPA Controllers are Deployed
# ======================================================
- name: Check for capi-controller-manager deployment
  shell: |
    oc --context='{{ ocp_context }}' get deploy -n multicluster-engine -ojson |\
    jq -c '.items[] | select(.metadata.name | contains("capi-controller-manager")) | {name: .metadata.name, creationTimestamp: .metadata.creationTimestamp}'
  register: capi_controller_manager
  failed_when: false
  changed_when: false

- name: Fail if CAPI controller not found
  fail:
    msg: "â„¹ï¸  Environment not configured yet - Ready to set up! Click the 'Configure' button in the Components card to install CAPI/CAPA controllers (~2 minutes)"
  when: capi_controller_manager.stdout | length == 0

- name: CAPI Controller Check
  debug:
    msg: "âœ… Step 2a/3: CAPI controller deployed - {{ capi_controller_manager.stdout }}"

- name: Check for capa-controller-manager deployment
  shell: |
    oc --context='{{ ocp_context }}' get deploy -n multicluster-engine -ojson |\
    jq -c '.items[] | select(.metadata.name | contains("capa-controller-manager")) | {name: .metadata.name, creationTimestamp: .metadata.creationTimestamp}'
  register: capa_controller_manager
  failed_when: false
  changed_when: false

- name: Fail if CAPA controller not found
  fail:
    msg: "â„¹ï¸  AWS provider not configured yet - Click the 'Configure' button to add cluster-api-provider-aws (CAPA) for ROSA HCP support"
  when: capa_controller_manager.stdout | length == 0

- name: CAPA Controller Check
  debug:
    msg: "âœ… Step 2b/3: CAPA controller deployed - {{ capa_controller_manager.stdout }}"

# ======================================================
# STEP 3: Check Configuration Resources (Non-Critical)
# ======================================================
# These checks are informational - they don't cause failure
# because they may not exist yet if no clusters have been created
# ======================================================

- name: Get ClusterManager registration configuration
  shell: |
    oc --context='{{ ocp_context }}' get clusterManager -n multicluster-engine -ojson |\
    jq -c '.items[] | select(.spec.registrationConfiguration) | {name: "ClusterManager", creationTimestamp: .metadata.creationTimestamp}'
  register: registration_configuration_applied
  failed_when: false
  changed_when: false

- name: Check for ClusterManager registration configuration
  debug:
    msg: "âœ“ ClusterManager registration configuration found - {{ registration_configuration_applied.stdout }}"
  when: registration_configuration_applied.stdout | length > 0

- name: Info if registration configuration not found
  debug:
    msg: "â„¹ ClusterManager registration configuration not found (will be created during configuration)"
  when: registration_configuration_applied.stdout | length == 0

- name: Get ClusterRoleBinding
  shell: |
    oc --context='{{ ocp_context }}' get ClusterRoleBinding cluster-manager-registration-capi -ojson | jq -c '{name: .metadata.name, creationTimestamp: .metadata.creationTimestamp}'
  register: cluster_role_binding_applied
  failed_when: false
  changed_when: false

- name: Check for ClusterRoleBinding
  debug:
    msg: "âœ“ ClusterRoleBinding cluster-manager-registration-capi found - {{ cluster_role_binding_applied.stdout }}"
  when: cluster_role_binding_applied.stdout | length > 0

- name: Info if ClusterRoleBinding not found
  debug:
    msg: "â„¹ ClusterRoleBinding cluster-manager-registration-capi not found (will be created during configuration)"
  when: cluster_role_binding_applied.stdout | length == 0

- name: Get AWS credentials secret (capa-manager-bootstrap-credentials)
  shell: |
    oc --context='{{ ocp_context }}' get secret -n multicluster-engine capa-manager-bootstrap-credentials -ojson | jq -c '{name: .metadata.name, creationTimestamp: .metadata.creationTimestamp}'
  register: capa_manager_bootstrap_credentials_exists
  failed_when: false
  changed_when: false

- name: Check for AWS credentials secret
  debug:
    msg: "âœ“ Secret capa-manager-bootstrap-credentials found - {{ capa_manager_bootstrap_credentials_exists.stdout }}"
  when: capa_manager_bootstrap_credentials_exists.stdout | length > 0

- name: Info if AWS credentials secret not found
  debug:
    msg: "â„¹ Secret capa-manager-bootstrap-credentials not found (will be created during configuration)"
  when: capa_manager_bootstrap_credentials_exists.stdout | length == 0

- name: Get ROSA credentials secret
  shell: |
    oc --context='{{ ocp_context }}' get secret -n multicluster-engine rosa-creds-secret -ojson | jq -c '{name: .metadata.name, creationTimestamp: .metadata.creationTimestamp}'
  register: rosa_creds_secret_exists
  failed_when: false
  changed_when: false

- name: Check for ROSA credentials secret
  debug:
    msg: "âœ“ Secret rosa-creds-secret found - {{ rosa_creds_secret_exists.stdout }}"
  when: rosa_creds_secret_exists.stdout | length > 0

- name: Info if ROSA credentials secret not found
  debug:
    msg: "â„¹ Secret rosa-creds-secret not found (will be created during configuration)"
  when: rosa_creds_secret_exists.stdout | length == 0

- name: Get AWSClusterControllerIdentity
  shell: |
    oc --context='{{ ocp_context }}' get AWSClusterControllerIdentity default -ojson | jq -c '{name: .metadata.name, creationTimestamp: .metadata.creationTimestamp}'
  register: aws_cluster_controller_identity_exists
  failed_when: false
  changed_when: false

- name: Check for AWSClusterControllerIdentity
  debug:
    msg: "âœ“ AWSClusterControllerIdentity default found - {{ aws_cluster_controller_identity_exists.stdout }}"
  when: aws_cluster_controller_identity_exists.stdout | length > 0

- name: Info if AWSClusterControllerIdentity not found
  debug:
    msg: "â„¹ AWSClusterControllerIdentity default not found (will be created during configuration)"
  when: aws_cluster_controller_identity_exists.stdout | length == 0

# ======================================================
# STEP 4: Check for ROSA Cluster Resources (Informational)
# ======================================================
# These are purely informational - they show what clusters exist
# ======================================================

- name: Get ROSA-related namespaces
  shell: |
    oc --context='{{ ocp_context }}' get namespace -ojson | jq -c '.items[] | select(.metadata.name | test("rosa|capi")) | {name: .metadata.name, creationTimestamp: .metadata.creationTimestamp}'
  register: rosa_namespaces
  failed_when: false
  changed_when: false

- name: Check for ROSA namespaces
  debug:
    msg: "âœ“ Namespace found - {{ item }}"
  loop: "{{ rosa_namespaces.stdout_lines }}"
  when: rosa_namespaces.stdout_lines | length > 0

- name: Get ROSACluster resources (all namespaces)
  shell: |
    oc --context='{{ ocp_context }}' get rosacluster --all-namespaces -ojson | jq -c '.items[] | {namespace: .metadata.namespace, name: .metadata.name, creationTimestamp: .metadata.creationTimestamp, status: (if .metadata.deletionTimestamp then "Uninstalling" elif .status.ready then "Ready" else "Provisioning" end)}'
  register: rosa_clusters
  failed_when: false
  changed_when: false

- name: Check for ROSACluster resources
  debug:
    msg: "âœ“ ROSACluster found - {{ item }}"
  loop: "{{ rosa_clusters.stdout_lines }}"
  when: rosa_clusters.stdout_lines | length > 0

- name: Info if no ROSACluster resources found
  debug:
    msg: "â„¹ No ROSACluster resources found (this is normal if you haven't created any clusters yet)"
  when: rosa_clusters.stdout_lines | length == 0

- name: Get RosaControlPlane resources (all namespaces)
  shell: |
    oc --context='{{ ocp_context }}' get rosacontrolplane --all-namespaces -ojson | jq -c '.items[] | {namespace: .metadata.namespace, name: .metadata.name, creationTimestamp: .metadata.creationTimestamp, status: (if .metadata.deletionTimestamp then "Uninstalling" elif .status.ready then "Ready" else "Provisioning" end)}'
  register: rosa_control_planes
  failed_when: false
  changed_when: false

- name: Check for RosaControlPlane resources
  debug:
    msg: "âœ“ RosaControlPlane found - {{ item }}"
  loop: "{{ rosa_control_planes.stdout_lines }}"
  when: rosa_control_planes.stdout_lines | length > 0

- name: Info if no RosaControlPlane resources found
  debug:
    msg: "â„¹ No RosaControlPlane resources found (this is normal if you haven't created any clusters yet)"
  when: rosa_control_planes.stdout_lines | length == 0

- name: Get RosaNetwork resources (all namespaces)
  shell: |
    oc --context='{{ ocp_context }}' get rosanetwork --all-namespaces -ojson | jq -c '.items[] | {namespace: .metadata.namespace, name: .metadata.name, creationTimestamp: .metadata.creationTimestamp, status: (if .metadata.deletionTimestamp then "Deleting" elif .status.ready then "Ready" else "Configuring" end)}'
  register: rosa_networks
  failed_when: false
  changed_when: false

- name: Check for RosaNetwork resources
  debug:
    msg: "âœ“ RosaNetwork found - {{ item }}"
  loop: "{{ rosa_networks.stdout_lines }}"
  when: rosa_networks.stdout_lines | length > 0

- name: Info if no RosaNetwork resources found
  debug:
    msg: "â„¹ No RosaNetwork resources found (this is normal if you haven't created any clusters yet)"
  when: rosa_networks.stdout_lines | length == 0

- name: Get Cluster resources (all namespaces)
  shell: |
    oc --context='{{ ocp_context }}' get cluster --all-namespaces -ojson | jq -c '.items[] | {namespace: .metadata.namespace, name: .metadata.name, creationTimestamp: .metadata.creationTimestamp, status: (if .status.phase then .status.phase else "Active" end)}'
  register: capi_clusters
  failed_when: false
  changed_when: false

- name: Check for CAPI Cluster resources
  debug:
    msg: "âœ“ Cluster found - {{ item }}"
  loop: "{{ capi_clusters.stdout_lines }}"
  when: capi_clusters.stdout_lines | length > 0

- name: Info if no CAPI Cluster resources found
  debug:
    msg: "â„¹ No Cluster resources found (this is normal if you haven't created any clusters yet)"
  when: capi_clusters.stdout_lines | length == 0

# ======================================================
# SUCCESS: Environment is Fully Configured
# ======================================================
- name: Environment validation complete
  debug:
    msg: |

      âœ… âœ… âœ… ENVIRONMENT CONFIGURED AND READY TO GO! âœ… âœ… âœ…

      All required components are in place:

      âœ“ OCP Hub Connection: {{ ocp_context }}
      âœ“ CAPI Controller: Deployed and running
      âœ“ CAPA Controller: Deployed and running

      ðŸŽ‰ Your MCE environment is ready for ROSA HCP cluster provisioning!

      Next steps:
      - Create ROSA HCP clusters using the UI
      - Upload YAML templates to provision clusters
      - Monitor cluster status and resources

      Happy cluster provisioning! ðŸš€
