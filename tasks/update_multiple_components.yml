- name: Update multiple MCE components in a single atomic operation
  block:
  - name: Get name of MCE (if not already cached)
    shell: oc get mce -n multicluster-engine -ojson | jq -r '.items[].metadata.name'
    register: mce_name_query
    when: mce_name is not defined

  - name: Use cached or queried MCE name
    set_fact:
      mce_resource_name: "{{ mce_name | default(mce_name_query.stdout) }}"

  - name: Get current components array
    shell: |
      oc get mce {{ mce_resource_name }} -n multicluster-engine -ojson | jq -c '.spec.overrides.components // []'
    register: current_components

  - name: Build list of component names to update
    set_fact:
      component_names: "{{ components_to_update | map(attribute='name') | list }}"

  - name: Remove existing entries for components being updated
    shell: |
      echo '{{ current_components.stdout }}' | jq -c 'map(select([.name] | inside({{ component_names | to_json }}) | not))'
    register: filtered_components

  - name: Build new components array with updated values
    set_fact:
      new_components: >-
        {{
          components_to_update | map('combine', {'configOverrides': {}}) | list
        }}

  - name: Merge filtered components with new components
    shell: |
      echo '{{ filtered_components.stdout }}' | jq -c '. + {{ new_components | to_json }}'
    register: updated_components

  - name: Apply updated components array to MCE (atomic patch)
    shell: |
      oc patch mce {{ mce_resource_name }} -n multicluster-engine --type=merge -p '{"spec":{"overrides":{"components":{{ updated_components.stdout }}}}}'
    changed_when: true
    register: patch_status

  - name: Display patch result
    debug:
      msg: "Updated {{ components_to_update | length }} components: {{ component_names | join(', ') }}"
