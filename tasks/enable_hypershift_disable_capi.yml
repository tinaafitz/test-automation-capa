- name: Enable Hypershift and Disable CAPI
  block:
  # Step 1: Enable BOTH Hypershift components in a single atomic patch
  - name: Enable both Hypershift components atomically
    include_tasks: "{{ AUTOMATION_PATH }}/tasks/update_multiple_components.yml"
    vars:
      components_to_update:
        - name: "hypershift"
          enabled: true
        - name: "hypershift-local-hosting"
          enabled: true

  # Wait for MCE to reconcile Hypershift components before proceeding
  - name: Wait for MCE to accept Hypershift configuration
    shell: |
      oc get mce {{ mce_name }} -n {{ mce_namespace }} -o jsonpath='{.spec.overrides.components[?(@.name=="hypershift")].enabled}'
    register: hypershift_config_check
    until: hypershift_config_check.stdout == "true"
    retries: 10
    delay: 1
    changed_when: false

  # Step 2: Disable BOTH CAPI components in a single atomic patch
  - name: Disable both CAPI components atomically
    include_tasks: "{{ AUTOMATION_PATH }}/tasks/update_multiple_components.yml"
    vars:
      components_to_update:
        - name: "cluster-api"
          enabled: false
        - name: "cluster-api-provider-aws"
          enabled: false
