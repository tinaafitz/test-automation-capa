name: PR Checks

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate PR Title (Semantic)
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            test
            chore
            ci
          requireScope: false
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            didn't match the configured pattern. Please ensure that the subject
            doesn't start with an uppercase character.

      - name: Check PR Size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const changes = additions + deletions;

            console.log(`PR changes: ${changes} (additions: ${additions}, deletions: ${deletions})`);

            if (changes > 1000) {
              core.setFailed(`PR is too large (${changes} changes). Please split into smaller PRs.`);
            } else if (changes > 500) {
              core.warning(`PR is large (${changes} changes). Consider splitting into smaller PRs.`);
            } else {
              console.log(`PR size is acceptable (${changes} changes)`);
            }

      - name: Analyze Changed Files
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });

            const changedFiles = files.data.map(f => f.filename);
            const playbookFiles = changedFiles.filter(f => f.match(/^playbooks\/.*\.ya?ml$/));
            const taskFiles = changedFiles.filter(f => f.match(/^tasks\/.*\.ya?ml$/));
            const testSuiteFiles = changedFiles.filter(f => f.match(/^test-suites\/.*\.json$/));
            const templateFiles = changedFiles.filter(f => f.match(/^templates\/.*\.j2$/));
            const pythonFiles = changedFiles.filter(f => f.endsWith('.py'));

            let comment = '### ðŸ“Š Changed Files Analysis\n\n';

            if (playbookFiles.length > 0) {
              comment += `**Playbooks** (${playbookFiles.length}):\n`;
              playbookFiles.forEach(f => comment += `- ${f}\n`);
              comment += '\n';
            }

            if (taskFiles.length > 0) {
              comment += `**Tasks** (${taskFiles.length}):\n`;
              taskFiles.forEach(f => comment += `- ${f}\n`);
              comment += '\n';
            }

            if (testSuiteFiles.length > 0) {
              comment += `**Test Suites** (${testSuiteFiles.length}):\n`;
              testSuiteFiles.forEach(f => comment += `- ${f}\n`);
              comment += '\n';
            }

            if (templateFiles.length > 0) {
              comment += `**Templates** (${templateFiles.length}):\n`;
              templateFiles.forEach(f => comment += `- ${f}\n`);
              comment += '\n';
            }

            if (pythonFiles.length > 0) {
              comment += `**Python Scripts** (${pythonFiles.length}):\n`;
              pythonFiles.forEach(f => comment += `- ${f}\n`);
              comment += '\n';
            }

            // Check for sensitive files
            const sensitiveFiles = changedFiles.filter(f =>
              f.includes('user_vars') ||
              f.includes('credentials') ||
              f.includes('.env')
            );

            if (sensitiveFiles.length > 0) {
              comment += 'âš ï¸ **WARNING: Sensitive files detected!**\n';
              sensitiveFiles.forEach(f => comment += `- ${f}\n`);
              comment += '\nPlease ensure no credentials are committed.\n\n';
            }

            // Post comment (or log if no permissions)
            try {
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number
              });

              const botComment = comments.data.find(c =>
                c.user.type === 'Bot' && c.body.includes('Changed Files Analysis')
              );

              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: comment
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: comment
                });
              }
              console.log('Posted changed files analysis to PR');
            } catch (error) {
              console.log('Unable to post comment (permissions issue), logging analysis instead:');
              console.log(comment);
            }
