name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  yaml-lint:
    name: YAML Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install yamllint
        run: pip install yamllint

      - name: Run yamllint
        run: |
          yamllint -f parsable playbooks/ tasks/ || true
          echo "YAML linting completed (warnings allowed)"

  ansible-lint:
    name: Ansible Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible and ansible-lint
        run: |
          pip install ansible ansible-lint

      - name: Run ansible-lint
        run: |
          ansible-lint playbooks/ || true
          echo "Ansible linting completed (warnings allowed)"

  ansible-syntax:
    name: Ansible Syntax Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: pip install ansible

      - name: Syntax check playbooks
        run: |
          for playbook in playbooks/*.yml; do
            echo "Checking syntax: $playbook"
            ansible-playbook --syntax-check "$playbook" || echo "Syntax check failed for $playbook (may need vars)"
          done

  python-lint:
    name: Python Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install linting tools
        run: |
          pip install black pylint

      - name: Run black (format check)
        run: |
          black --check *.py || true
          echo "Python formatting check completed"

      - name: Run pylint
        run: |
          pylint *.py --disable=C,R || true
          echo "Python linting completed (warnings allowed)"

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run TruffleHog secret scanner
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

  test-suite-dry-run:
    name: Test Suite Dry Run
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: pip install ansible

      - name: Create dummy user_vars.yml
        run: |
          mkdir -p vars
          cat > vars/user_vars.yml << 'EOF'
          ---
          # Dummy variables for CI testing
          OCP_HUB_API_URL: "https://api.test.example.com:6443"
          OCP_HUB_CLUSTER_USER: "test-user"
          OCP_HUB_CLUSTER_PASSWORD: "dummy-password"
          AWS_REGION: "us-west-2"
          AWS_ACCESS_KEY_ID: "AKIAIOSFODNN7EXAMPLE"
          AWS_SECRET_ACCESS_KEY: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
          AWS_ACCOUNT_ID: "123456789012"
          OCM_CLIENT_ID: "test-client-id"
          OCM_CLIENT_SECRET: "test-client-secret"
          MCE_NAMESPACE: "multicluster-engine"
          EOF

      - name: Validate test suite JSON files
        run: |
          for suite in test-suites/*.json; do
            echo "Validating $suite"
            python3 -m json.tool "$suite" > /dev/null || exit 1
          done
          echo "All test suite files are valid JSON"

      - name: Test run-test-suite.py --list
        run: |
          chmod +x ./run-test-suite.py
          ./run-test-suite.py --list

      - name: Test run-test-suite.py help
        run: |
          ./run-test-suite.py --help

  all-checks-passed:
    name: All CI Checks Passed
    runs-on: ubuntu-latest
    needs:
      - yaml-lint
      - ansible-lint
      - ansible-syntax
      - python-lint
      - security-scan
      - test-suite-dry-run
    if: always()
    steps:
      - name: Check if all jobs passed
        run: |
          if [[ "${{ needs.yaml-lint.result }}" != "success" ]] || \
             [[ "${{ needs.ansible-lint.result }}" != "success" ]] || \
             [[ "${{ needs.ansible-syntax.result }}" != "success" ]] || \
             [[ "${{ needs.python-lint.result }}" != "success" ]] || \
             [[ "${{ needs.security-scan.result }}" != "success" ]] || \
             [[ "${{ needs.test-suite-dry-run.result }}" != "success" ]]; then
            echo "Some checks failed"
            exit 1
          else
            echo "All checks passed!"
          fi
