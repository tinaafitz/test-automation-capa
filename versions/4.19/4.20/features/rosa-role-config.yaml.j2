---
# ROSARoleConfig Template for v1beta2 API
# Automates AWS IAM role creation for ROSA HCP clusters

apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
kind: ROSARoleConfig
metadata:
  name: {{ rosa_role_config_name | default(cluster_name + "-roles") }}
  namespace: {{ capi_namespace | default("ns-rosa-hcp") }}
  labels:
    cluster.x-k8s.io/cluster-name: {{ cluster_name }}
    automation.acm.redhat.com/created-by: "ansible-automation"
  annotations:
    automation.acm.redhat.com/description: "Automated ROSARoleConfig for {{ cluster_name }}"
    automation.acm.redhat.com/timestamp: "{{ ansible_date_time.iso8601 }}"
spec:
  # AWS Identity Reference (required for authentication)
  identityRef:
    kind: AWSClusterControllerIdentity
    name: default

  # Account-wide IAM roles configuration
  accountRoleConfig:
    prefix: "{{ (rosa_role_prefix | default(cluster_name))[:4] | regex_replace('-$', '') }}"
    version: {{ openshift_version | default("4.20") }}
    sharedVPCConfig: {}

  # Cluster-specific operator IAM roles configuration
  operatorRoleConfig:
    prefix: "{{ (rosa_role_prefix | default(cluster_name))[:4] | regex_replace('-$', '') }}"
    sharedVPCConfig: {}

  # OIDC Provider Type (Managed or Unmanaged)
  oidcProviderType: Managed

  # AWS Credentials Secret Reference
  credentialsSecretRef:
    name: rosa-creds-secret
